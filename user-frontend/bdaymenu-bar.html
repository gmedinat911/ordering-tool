<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bar Menu â€” The Evening Bar</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./merchant-theme.css" />
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <div class="brand-mark"></div>
        <div>
          <div class="brand-name">The Evening Bar</div>
          <div class="subtitle">Signature Cocktails</div>
        </div>
      </div>
    </header>

    <section class="menu-grid">
      <!-- Kristin Bday Margarita -->
      <article class="card drink" data-canonical="Tommys Margarita">
        <div class="img-wrap">
          <img src="https://images.unsplash.com/photo-1604908554007-9f4a74e6a1b0?q=80&w=1200&auto=format&fit=crop" alt="Margarita"/>
        </div>
        <h3>Kristin Bday Margarita</h3>
        <p>Tequila, fresh lime, and agave. Bright, clean, and perfectly balanced.</p>
        <p class="stock-info"></p>
        <a class="btn gold order-btn whatsapp-btn" href="#">
          <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="height:16px"> Order
        </a>
        <a class="btn order-btn order-now" href="#">ðŸ›’ Order Now</a>
      </article>

      <!-- Kristin Mojito -->
      <article class="card drink" data-canonical="Regular Mojito">
        <div class="badge">Out of Stock</div>
        <div class="img-wrap">
          <img src="https://images.unsplash.com/photo-1604908812105-1c917f651350?q=80&w=1200&auto=format&fit=crop" alt="Mojito"/>
        </div>
        <h3>Kristin Mojito</h3>
        <p>Fresh mint, lime, cane sugar, white rum, and a crisp soda lift.</p>
        <p class="stock-info"></p>
        <a class="btn order-btn whatsapp-btn disabled">Order</a>
        <a class="btn order-btn order-now disabled">ðŸ›’ Order Now</a>
      </article>

      <!-- Kristin Gin Southside -->
      <article class="card drink" data-canonical="Gin Southside">
        <div class="badge">Out of Stock</div>
        <div class="img-wrap">
          <img src="https://images.unsplash.com/photo-1560518883-ce09059eeffa?q=80&w=1200&auto=format&fit=crop" alt="Gin Southside"/>
        </div>
        <h3>Kristin Gin Southside</h3>
        <p>Gin, mint, and lime with chilled clarity. A timeless classic.</p>
        <p class="stock-info"></p>
        <a class="btn order-btn whatsapp-btn disabled">Order</a>
        <a class="btn order-btn order-now disabled">ðŸ›’ Order Now</a>
      </article>

      <!-- Paloma Paradise -->
      <article class="card drink" data-canonical="Paloma">
        <div class="badge">Out of Stock</div>
        <div class="img-wrap">
          <img src="https://images.unsplash.com/photo-1527960471264-932f39eb5840?q=80&w=1200&auto=format&fit=crop" alt="Paloma"/>
        </div>
        <h3>Paloma Paradise</h3>
        <p>Tequila and grapefruit with a touch of sea salt for a zesty finish.</p>
        <p class="stock-info"></p>
        <a class="btn order-btn whatsapp-btn disabled">Order</a>
        <a class="btn order-btn order-now disabled">ðŸ›’ Order Now</a>
      </article>

      <!-- Cosmo Crush -->
      <article class="card drink" data-canonical="Cosmopolitan">
        <div class="badge">Out of Stock</div>
        <div class="img-wrap">
          <img src="https://images.unsplash.com/photo-1541976076758-347942db1970?q=80&w=1200&auto=format&fit=crop" alt="Cosmopolitan"/>
        </div>
        <h3>Cosmo Crush</h3>
        <p>Vodka, cranberry, orange liqueur, and fresh lime â€” chilled to perfection.</p>
        <p class="stock-info"></p>
        <a class="btn order-btn whatsapp-btn disabled">Order</a>
        <a class="btn order-btn order-now disabled">ðŸ›’ Order Now</a>
      </article>

      <!-- Espresso Kristinni -->
      <article class="card drink" data-canonical="Espresso Martini">
        <div class="img-wrap">
          <img src="https://images.unsplash.com/photo-1504674900247-0877df9cc836?q=80&w=1200&auto=format&fit=crop" alt="Espresso Martini"/>
        </div>
        <h3>Espresso Kristinni</h3>
        <p>Vodka, rich espresso, and coffee liqueur â€” silky and uplifting.</p>
        <p class="stock-info"></p>
        <a class="btn gold order-btn whatsapp-btn" href="#">
          <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="height:16px"> Order
        </a>
        <a class="btn order-btn order-now" href="#">ðŸ›’ Order Now</a>
      </article>
    </section>

    <footer class="footer">
      <div>Ask our team for recommendations. Please drink responsibly.</div>
      <div class="hr"></div>
    </footer>
  </div>

<style>
  .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display:flex; flex-direction:column; gap:8px; align-items:center; }
  .toast { background:#111827; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 10px 24px rgba(0,0,0,.25); font-weight:600; opacity:.95; max-width:90vw; }
  .order-btn + .order-btn { margin-left: 8px; }
</style>
<div id="toasts" class="toast-container" aria-live="polite" aria-atomic="true"></div>

<script>
  const API_BASE = 'https://whatsapp-cocktail-bot.onrender.com';
  const waNumber = '19844809046';
  const ORDER_URL = `${API_BASE}/order`;
  const storage = window.localStorage;
  let clientId = storage.getItem('clientId') || '';
  const pendingOrders = new Set();

  function showToast(message) {
    const box = document.getElementById('toasts');
    if (!box) return alert(message);
    const el = document.createElement('div');
    el.className = 'toast'; el.textContent = message; box.appendChild(el);
    setTimeout(() => el.remove(), 2500);
  }

  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = atob(base64); const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
    return outputArray;
  }

  async function ensurePushSubscription() {
    try {
      if (!('serviceWorker' in navigator) || !('PushManager' in window)) return null;
      const reg = await navigator.serviceWorker.register('./sw.js');
      let sub = await reg.pushManager.getSubscription();
      if (!sub) {
        const { key } = await (await fetch(`${API_BASE}/vapidPublicKey`)).json();
        const vapidKey = urlBase64ToUint8Array(key);
        sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: vapidKey });
      }
      const resp = await fetch(`${API_BASE}/subscribe`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ subscription: sub, clientId })});
      const out = await resp.json(); if (out && out.clientId) { clientId = out.clientId; storage.setItem('clientId', clientId); }
      return sub;
    } catch (e) { console.warn('Push subscription failed', e); return null; }
  }

  // Listen for done events via SSE
  try {
    const es = new EventSource(`${API_BASE}/events`);
    es.addEventListener('order_done', (evt) => {
      try {
        const payload = JSON.parse(evt.data || '{}');
        if (payload && payload.id && pendingOrders.has(payload.id)) {
          pendingOrders.delete(payload.id);
          if ('Notification' in window && Notification.permission === 'granted') {
            try { new Notification('Your drink is ready! ðŸŽ‰', { body: `${payload.displayName || payload.cocktail} is ready for pickup.` }); }
            catch { showToast(`${payload.displayName || payload.cocktail} is ready!`); }
          } else { showToast(`${payload.displayName || payload.cocktail} is ready!`); }
        }
      } catch (e) { console.error('SSE parse error', e); }
    });
  } catch (e) { console.warn('SSE not available', e); }

  async function placeOrder(drinkEl, canonical, displayName) {
    const btnWA = drinkEl.querySelector('.order-btn.whatsapp-btn');
    const btnON = drinkEl.querySelector('.order-btn.order-now');
    const info = drinkEl.querySelector('.stock-info');
    const origONText = btnON ? btnON.textContent : '';
    try {
      [btnWA, btnON].forEach(btn => { if (btn) btn.classList.add('disabled'); });
      if (btnON) btnON.textContent = 'â³ Placing...';
      if ('Notification' in window && Notification.permission === 'default') { try { await Notification.requestPermission(); } catch {} }
      await ensurePushSubscription();
      const resp = await fetch(ORDER_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ canonical, drink: displayName, clientId })});
      if (resp.ok) {
        let result = {}; try { result = await resp.json(); } catch {}
        if (result && result.id) pendingOrders.add(result.id);
        showToast('We received your order. It\'s being prepared!');
        const match = /^(\d+)/.exec(info.textContent || ''); let left = match ? parseInt(match[1], 10) : 0; if (left > 0) left -= 1; info.textContent = left > 0 ? `${left} left` : 'Out of stock';
        if (left === 0) {
          let b = drinkEl.querySelector('.badge'); if (!b) { b = document.createElement('div'); b.className='badge'; drinkEl.insertBefore(b, drinkEl.firstChild); }
          b.textContent = 'Out of Stock';
          [btnWA, btnON].forEach(btn => { if (!btn) return; btn.classList.add('disabled'); btn.removeAttribute('href'); btn.textContent = 'Out of Stock'; });
        } else {
          if (btnON) btnON.textContent = 'âœ… Added to Queue'; setTimeout(() => { if (btnON) btnON.textContent = origONText || 'ðŸ›’ Order Now'; }, 1500);
          [btnWA, btnON].forEach(btn => { if (btn) btn.classList.remove('disabled'); });
        }
      } else if (resp.status === 409) {
        info.textContent = 'Out of stock'; let b = drinkEl.querySelector('.badge'); if (!b) { b = document.createElement('div'); b.className='badge'; drinkEl.insertBefore(b, drinkEl.firstChild); } b.textContent = 'Out of Stock';
      } else {
        console.error('Order failed', await resp.text()); if (btnON) btnON.textContent = 'âŒ Try Again'; showToast('Order failed. Please try again.'); setTimeout(() => { if (btnON) btnON.textContent = origONText || 'ðŸ›’ Order Now'; }, 2000);
      }
    } catch (e) {
      console.error('Order error', e); if (btnON) btnON.textContent = 'âŒ Error'; showToast('An error occurred. Please try again.'); setTimeout(() => { if (btnON) btnON.textContent = origONText || 'ðŸ›’ Order Now'; }, 2000);
    } finally {
      if (!/Out of stock/i.test(info.textContent)) { [btnWA, btnON].forEach(btn => { if (btn) btn.classList.remove('disabled'); }); }
    }
  }

  (async () => {
    try {
      const res = await fetch(`${API_BASE}/menu`);
      const data = await res.json();
      const menuMap = {}; data.forEach(item => { menuMap[item.canonical] = item.stock_count; });

      document.querySelectorAll('.drink').forEach(drinkEl => {
        const canonical = drinkEl.getAttribute('data-canonical');
        const stock = menuMap[canonical] || 0;
        const info = drinkEl.querySelector('.stock-info');
        let badgeEl = drinkEl.querySelector('.badge');
        const btnWA = drinkEl.querySelector('.order-btn.whatsapp-btn');
        const btnON = drinkEl.querySelector('.order-btn.order-now');
        const displayName = drinkEl.querySelector('h3').innerText.trim();
        info.textContent = stock > 0 ? `${stock} left` : 'Out of stock';

        const text = encodeURIComponent(`I'd like to order the ${displayName}!`);
        if (stock === 0) {
          if (!badgeEl) { const b = document.createElement('div'); b.className='badge'; b.textContent='Out of Stock'; drinkEl.insertBefore(b, drinkEl.firstChild); } else { badgeEl.textContent='Out of Stock'; }
          [btnWA, btnON].forEach(btn => { if (!btn) return; btn.classList.add('disabled'); btn.removeAttribute('href'); });
        } else if (stock <= 10) {
          if (!badgeEl) { const b = document.createElement('div'); b.className='badge low'; b.textContent='Low Stock'; drinkEl.insertBefore(b, drinkEl.firstChild); } else { badgeEl.classList.add('low'); badgeEl.textContent='Low Stock'; }
          if (btnWA) { btnWA.classList.remove('disabled'); btnWA.setAttribute('href', `https://wa.me/${waNumber}?text=${text}`); }
          if (btnON) { btnON.classList.remove('disabled'); btnON.textContent='ðŸ›’ Order Now'; btnON.addEventListener('click', (e) => { e.preventDefault(); placeOrder(drinkEl, canonical, displayName); }); }
        } else {
          if (badgeEl) badgeEl.remove();
          if (btnWA) { btnWA.classList.remove('disabled'); btnWA.setAttribute('href', `https://wa.me/${waNumber}?text=${text}`); }
          if (btnON) { btnON.classList.remove('disabled'); btnON.textContent='ðŸ›’ Order Now'; btnON.addEventListener('click', (e) => { e.preventDefault(); placeOrder(drinkEl, canonical, displayName); }); }
        }
      });
    } catch (err) { console.error('Stock script error', err); }
  })();
</script>
</body>
</html>
