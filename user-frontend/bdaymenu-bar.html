<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bar Menu — The Evening Bar</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./merchant-theme.css" />
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <div class="brand-mark"></div>
        <div>
          <div class="brand-name">The Evening Bar</div>
          <div class="subtitle">Signature Cocktails</div>
        </div>
      </div>
    </header>

    <section class="menu-grid">
      <!-- Kristin Bday Margarita -->
      <article class="card drink" data-canonical="Tommys Margarita">
        <div class="img-wrap">
          <img loading="lazy" src="https://ellegourmet.ca/wp-content/uploads/2023/04/2023-0223-EG-3856-scaled-e1681778702757.jpg" alt="Margarita" onerror="this.onerror=null;this.src='https://picsum.photos/seed/margarita/1200/900';"/>
        </div>
        <h3>Kristin Bday Margarita</h3>
        <p>Tequila, fresh lime, and agave. Bright, clean, and perfectly balanced.</p>
        <p class="stock-info"></p>
        <a class="btn gold order-btn whatsapp-btn" href="#">
          <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="height:16px"> Order
        </a>
        <a class="btn order-btn order-now" href="#">🛒 Order Now</a>
      </article>

      <!-- Kristin Mojito -->
      <article class="card drink" data-canonical="Regular Mojito">
        <div class="badge">Out of Stock</div>
        <div class="img-wrap">
          <img loading="lazy" src="https://cdn.prod.website-files.com/594bcc8db100b47a2a8c2e38/63c56ab1e9a2118a419d7478_5c3dd63342cd1574af5ac0e4_Mojito-p-1080.webp" alt="Mojito" onerror="this.onerror=null;this.src='https://picsum.photos/seed/mojito/1200/900';"/>
        </div>
        <h3>Kristin Mojito</h3>
        <p>Fresh mint, lime, cane sugar, white rum, and a crisp soda lift.</p>
        <p class="stock-info"></p>
        <a class="btn order-btn whatsapp-btn disabled">Order</a>
        <a class="btn order-btn order-now disabled">🛒 Order Now</a>
      </article>

      <!-- Kristin Gin Southside -->
      <article class="card drink" data-canonical="Gin Southside">
        <div class="badge">Out of Stock</div>
        <div class="img-wrap">
          <img loading="lazy" src="https://images.squarespace-cdn.com/content/v1/5668afe4c21b86d8ce6fc49c/1550351337684-7X5ZX29ZLZ64WDL0OYIN/EditorialCocktails_2x_0046_Southside_Gallery3X.png.png?format=1500w" alt="Gin Southside" onerror="this.onerror=null;this.src='https://picsum.photos/seed/southside/1200/900';"/>
        </div>
        <h3>Kristin Gin Southside</h3>
        <p>Gin, mint, and lime with chilled clarity. A timeless classic.</p>
        <p class="stock-info"></p>
        <a class="btn order-btn whatsapp-btn disabled">Order</a>
        <a class="btn order-btn order-now disabled">🛒 Order Now</a>
      </article>

      <!-- Paloma Paradise -->
      <article class="card drink" data-canonical="Paloma">
        <div class="badge">Out of Stock</div>
        <div class="img-wrap">
          <img loading="lazy" src="https://images.pexels.com/photos/16444380/pexels-photo-16444380.jpeg?cs=srgb&dl=pexels-esmihel-16444380.jpg&fm=jpg" alt="Paloma" onerror="this.onerror=null;this.src='https://picsum.photos/seed/paloma/1200/900';"/>
        </div>
        <h3>Paloma Paradise</h3>
        <p>Tequila and grapefruit with a touch of sea salt for a zesty finish.</p>
        <p class="stock-info"></p>
        <a class="btn order-btn whatsapp-btn disabled">Order</a>
        <a class="btn order-btn order-now disabled">🛒 Order Now</a>
      </article>

      <!-- Cosmo Crush -->
      <article class="card drink" data-canonical="Cosmopolitan">
        <div class="badge">Out of Stock</div>
        <div class="img-wrap">
          <img loading="lazy" src="https://www.foodandwine.com/thmb/acb9flfE2zc1INtjCpMv8slaVvs=/750x0/filters:no_upscale():max_bytes(150000):strip_icc()/Cosmopolitan-FT-BLOG1122-34b1c314ea3b4b338535f4dd93b754a7.jpg" alt="Cosmopolitan" onerror="this.onerror=null;this.src='https://picsum.photos/seed/cosmo/1200/900';"/>
        </div>
        <h3>Cosmo Crush</h3>
        <p>Vodka, cranberry, orange liqueur, and fresh lime — chilled to perfection.</p>
        <p class="stock-info"></p>
        <a class="btn order-btn whatsapp-btn disabled">Order</a>
        <a class="btn order-btn order-now disabled">🛒 Order Now</a>
      </article>

      <!-- Espresso Kristinni -->
      <article class="card drink" data-canonical="Espresso Martini">
        <div class="img-wrap">
          <img loading="lazy" src="https://filodeagave.com/wp-content/uploads/2024/08/Tequila-Espresso-Martini-Cocktail-Recipe-v002.jpg" alt="Espresso Martini" onerror="this.onerror=null;this.src='https://picsum.photos/seed/espresso/1200/900';"/>
        </div>
        <h3>Espresso Kristinni</h3>
        <p>Vodka, rich espresso, and coffee liqueur — silky and uplifting.</p>
        <p class="stock-info"></p>
        <a class="btn gold order-btn whatsapp-btn" href="#">
          <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="height:16px"> Order
        </a>
        <a class="btn order-btn order-now" href="#">🛒 Order Now</a>
      </article>
    </section>

    <footer class="footer">
      <div>Ask our team for recommendations. Please drink responsibly.</div>
      <div class="hr"></div>
    </footer>
  </div>

<style>
  .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display:flex; flex-direction:column; gap:8px; align-items:center; }
  .toast { background:#111827; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 10px 24px rgba(0,0,0,.25); font-weight:600; opacity:.95; max-width:90vw; }
  .order-btn + .order-btn { margin-left: 8px; }
</style>
<div id="toasts" class="toast-container" aria-live="polite" aria-atomic="true"></div>

<!-- Profile Gate -->
<style>
  .gate-overlay{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:9998}
  .gate-card{background:var(--surface); border:1px solid var(--divider); border-radius:16px; padding:20px; width:min(92vw, 420px); box-shadow:0 30px 50px rgba(0,0,0,.45)}
  .gate-card h3{font-family:'Playfair Display',serif; margin:0 0 10px}
  .gate-row{display:flex; gap:10px; margin:10px 0}
  .gate-card input{flex:1; background:#0f1115; color:var(--cream); border:1px solid var(--divider); border-radius:10px; padding:10px}
  .gate-actions{display:flex; gap:10px; justify-content:flex-end; margin-top:12px}
  .btn-small{padding:10px 14px; border-radius:10px; border:1px solid var(--divider); background:transparent; color:var(--cream); cursor:pointer}
  .btn-small.primary{background:var(--gold); color:#111; border:none}
  .gate-error{color:#ff9b9b; font-weight:700; font-size:.9rem; min-height:1.2em}
</style>
<div id="profileGate" class="gate-overlay" role="dialog" aria-modal="true">
  <div class="gate-card">
    <h3>Welcome! Before we begin</h3>
    <p class="muted">Please tell us your first name and confirm you are of legal drinking age.</p>
    <div class="gate-row">
      <input id="gateName" type="text" placeholder="First name" autocomplete="given-name"/>
    </div>
    <div class="gate-row">
      <input id="gateAge" type="number" min="0" placeholder="Your age"/>
    </div>
    <div id="gateError" class="gate-error"></div>
    <div class="gate-actions">
      <button id="gateCancel" class="btn-small">Cancel</button>
      <button id="gateContinue" class="btn-small primary">Continue</button>
    </div>
  </div>
  
</div>

<script>
  const API_BASE = 'https://whatsapp-cocktail-bot.onrender.com';
  const waNumber = '19844809046';
  const ORDER_URL = `${API_BASE}/order`;
  const storage = window.localStorage;
  let clientId = storage.getItem('clientId') || '';
  const pendingOrders = new Set();
  const AGE_MIN = 21; // adjust if needed

  function getProfile(){
    try { return JSON.parse(storage.getItem('guestProfile') || ''); } catch { return null; }
  }
  function saveProfile(p){ storage.setItem('guestProfile', JSON.stringify(p)); }
  function ensureProfileGate(onDone){
    const prof = getProfile();
    if (prof && prof.name && prof.age && Number(prof.age) >= AGE_MIN) { onDone && onDone(prof); return; }
    const gate = document.getElementById('profileGate');
    const nameEl = document.getElementById('gateName');
    const ageEl = document.getElementById('gateAge');
    const errEl = document.getElementById('gateError');
    gate.style.display = 'flex';
    document.getElementById('gateCancel').onclick = () => { gate.style.display = 'none'; };
    document.getElementById('gateContinue').onclick = () => {
      const n = (nameEl.value || '').trim();
      const a = parseInt(ageEl.value || '0', 10);
      if (!n) { errEl.textContent = 'Please enter your name.'; return; }
      if (!a || a < AGE_MIN) { errEl.textContent = `You must be at least ${AGE_MIN}.`; return; }
      const profile = { name: n, age: a, ts: Date.now() };
      saveProfile(profile);
      gate.style.display = 'none';
      onDone && onDone(profile);
    };
  }

  function showToast(message) {
    const box = document.getElementById('toasts');
    if (!box) return alert(message);
    const el = document.createElement('div');
    el.className = 'toast'; el.textContent = message; box.appendChild(el);
    setTimeout(() => el.remove(), 2500);
  }

  function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
    const rawData = atob(base64); const outputArray = new Uint8Array(rawData.length);
    for (let i = 0; i < rawData.length; ++i) outputArray[i] = rawData.charCodeAt(i);
    return outputArray;
  }

  async function ensurePushSubscription() {
    try {
      if (!('serviceWorker' in navigator) || !('PushManager' in window)) return null;
      const reg = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
      let sub = await reg.pushManager.getSubscription();
      if (!sub) {
        const { key } = await (await fetch(`${API_BASE}/vapidPublicKey`)).json();
        const vapidKey = urlBase64ToUint8Array(key);
        sub = await reg.pushManager.subscribe({ userVisibleOnly: true, applicationServerKey: vapidKey });
      }
      const resp = await fetch(`${API_BASE}/subscribe`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ subscription: sub, clientId })});
      const out = await resp.json();
      if (out && out.clientId) {
        clientId = out.clientId;
        storage.setItem('clientId', clientId);
        // Also log into OneSignal with the new clientId so backend can target by alias
        try {
          if (window.OneSignalDeferred) {
            window.OneSignalDeferred.push(async (OneSignal) => {
              try { await OneSignal.login(String(clientId)); }
              catch (e) { console.warn('OneSignal login after subscribe failed', e); }
            });
          }
        } catch {}
      }
      return sub;
    } catch (e) { console.warn('Push subscription failed', e); return null; }
  }

  // Listen for done events via SSE
  try {
    const es = new EventSource(`${API_BASE}/events`);
    es.addEventListener('order_done', (evt) => {
      try {
        const payload = JSON.parse(evt.data || '{}');
        const matchesId = payload && payload.id && pendingOrders.has(payload.id);
        const matchesClient = payload && payload.clientId && payload.clientId === clientId;
        if (matchesId || matchesClient) {
          if (matchesId && payload.id) pendingOrders.delete(payload.id);
          if ('Notification' in window && Notification.permission === 'granted') {
            try { new Notification('Your drink is ready! 🎉', { body: `${payload.displayName || payload.cocktail} is ready for pickup.` }); }
            catch { showToast(`${payload.displayName || payload.cocktail} is ready!`); }
          } else { showToast(`${payload.displayName || payload.cocktail} is ready!`); }
        }
      } catch (e) { console.error('SSE parse error', e); }
    });
  } catch (e) { console.warn('SSE not available', e); }

  async function placeOrder(drinkEl, canonical, displayName) {
    const btnWA = drinkEl.querySelector('.order-btn.whatsapp-btn');
    const btnON = drinkEl.querySelector('.order-btn.order-now');
    const info = drinkEl.querySelector('.stock-info');
    const origONText = btnON ? btnON.textContent : '';
    try {
      // Ensure profile before ordering
      await new Promise(resolve => ensureProfileGate(() => resolve()));
      const prof = getProfile() || {};
      [btnWA, btnON].forEach(btn => { if (btn) btn.classList.add('disabled'); });
      if (btnON) btnON.textContent = '⏳ Placing...';
      if ('Notification' in window && Notification.permission === 'default') { try { await Notification.requestPermission(); } catch {} }
      await ensurePushSubscription();
      const resp = await fetch(ORDER_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ canonical, drink: displayName, clientId, name: prof.name })});
      if (resp.ok) {
        let result = {}; try { result = await resp.json(); } catch {}
        if (result && result.id) pendingOrders.add(result.id);
        showToast('We received your order. It\'s being prepared!');
        const match = /^(\d+)/.exec(info.textContent || ''); let left = match ? parseInt(match[1], 10) : 0; if (left > 0) left -= 1; info.textContent = left > 0 ? `${left} left` : 'Out of stock';
        if (left === 0) {
          let b = drinkEl.querySelector('.badge'); if (!b) { b = document.createElement('div'); b.className='badge'; drinkEl.insertBefore(b, drinkEl.firstChild); }
          b.textContent = 'Out of Stock';
          [btnWA, btnON].forEach(btn => { if (!btn) return; btn.classList.add('disabled'); btn.removeAttribute('href'); btn.textContent = 'Out of Stock'; });
        } else {
          if (btnON) btnON.textContent = '✅ Added to Queue'; setTimeout(() => { if (btnON) btnON.textContent = origONText || '🛒 Order Now'; }, 1500);
          [btnWA, btnON].forEach(btn => { if (btn) btn.classList.remove('disabled'); });
        }
      } else if (resp.status === 409) {
        info.textContent = 'Out of stock'; let b = drinkEl.querySelector('.badge'); if (!b) { b = document.createElement('div'); b.className='badge'; drinkEl.insertBefore(b, drinkEl.firstChild); } b.textContent = 'Out of Stock';
      } else {
        console.error('Order failed', await resp.text()); if (btnON) btnON.textContent = '❌ Try Again'; showToast('Order failed. Please try again.'); setTimeout(() => { if (btnON) btnON.textContent = origONText || '🛒 Order Now'; }, 2000);
      }
    } catch (e) {
      console.error('Order error', e); if (btnON) btnON.textContent = '❌ Error'; showToast('An error occurred. Please try again.'); setTimeout(() => { if (btnON) btnON.textContent = origONText || '🛒 Order Now'; }, 2000);
    } finally {
      if (!/Out of stock/i.test(info.textContent)) { [btnWA, btnON].forEach(btn => { if (btn) btn.classList.remove('disabled'); }); }
    }
  }

  (async () => {
    try {
      const res = await fetch(`${API_BASE}/menu`);
      const data = await res.json();
      const menuMap = {}; data.forEach(item => { menuMap[item.canonical] = item.stock_count; });

      document.querySelectorAll('.drink').forEach(drinkEl => {
        const canonical = drinkEl.getAttribute('data-canonical');
        const stock = menuMap[canonical] || 0;
        const info = drinkEl.querySelector('.stock-info');
        let badgeEl = drinkEl.querySelector('.badge');
        const btnWA = drinkEl.querySelector('.order-btn.whatsapp-btn');
        const btnON = drinkEl.querySelector('.order-btn.order-now');
        const displayName = drinkEl.querySelector('h3').innerText.trim();
        info.textContent = stock > 0 ? `${stock} left` : 'Out of stock';

        const text = encodeURIComponent(`I'd like to order the ${displayName}!`);
        if (stock === 0) {
          if (!badgeEl) { const b = document.createElement('div'); b.className='badge'; b.textContent='Out of Stock'; drinkEl.insertBefore(b, drinkEl.firstChild); } else { badgeEl.textContent='Out of Stock'; }
          [btnWA, btnON].forEach(btn => { if (!btn) return; btn.classList.add('disabled'); btn.removeAttribute('href'); });
        } else if (stock <= 10) {
          if (!badgeEl) { const b = document.createElement('div'); b.className='badge low'; b.textContent='Low Stock'; drinkEl.insertBefore(b, drinkEl.firstChild); } else { badgeEl.classList.add('low'); badgeEl.textContent='Low Stock'; }
          if (btnWA) { btnWA.classList.remove('disabled'); btnWA.setAttribute('href', `https://wa.me/${waNumber}?text=${text}`); }
          if (btnON) { btnON.classList.remove('disabled'); btnON.textContent='🛒 Order Now'; btnON.addEventListener('click', (e) => { e.preventDefault(); placeOrder(drinkEl, canonical, displayName); }); }
        } else {
          if (badgeEl) badgeEl.remove();
          if (btnWA) { btnWA.classList.remove('disabled'); btnWA.setAttribute('href', `https://wa.me/${waNumber}?text=${text}`); }
          if (btnON) { btnON.classList.remove('disabled'); btnON.textContent='🛒 Order Now'; btnON.addEventListener('click', (e) => { e.preventDefault(); placeOrder(drinkEl, canonical, displayName); }); }
        }
      });
    } catch (err) { console.error('Stock script error', err); }
  })();
</script>

<!-- OneSignal Web Push (v16) -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  (async () => {
    try {
      const cfg = await fetch(`${API_BASE}/onesignal/config`).then(r => r.json()).catch(() => ({ appId: null }));
      if (!cfg || !cfg.appId) return; // OneSignal not configured
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      window.OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({ appId: cfg.appId });
        try {
          const cid = localStorage.getItem('clientId') || '';
          if (cid) { await OneSignal.login(String(cid)); }
        } catch (e) { console.warn('OneSignal login failed', e); }
        try { OneSignal.Slidedown.promptPush(); } catch {}
      });
    } catch (e) { console.warn('OneSignal init error', e); }
  })();
</script>
</body>
</html>
