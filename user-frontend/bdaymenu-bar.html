<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bar Menu â€” The Evening Bar</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./merchant-theme.css" />
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand">
        <div class="brand-mark"></div>
        <div>
          <div class="brand-name">The Evening Bar</div>
          <div class="subtitle">Signature Cocktails</div>
        </div>
      </div>
    </header>

    <section class="menu-grid" id="menuGrid"></section>

    <footer class="footer">
      <div>Ask our team for recommendations. Please drink responsibly.</div>
      <div class="hr"></div>
    </footer>
  </div>

<style>
  .toast-container { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display:flex; flex-direction:column; gap:8px; align-items:center; }
  .toast { background:#111827; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 10px 24px rgba(0,0,0,.25); font-weight:600; opacity:.95; max-width:90vw; }
  .order-btn + .order-btn { margin-left: 8px; }
</style>
<div id="toasts" class="toast-container" aria-live="polite" aria-atomic="true"></div>

<!-- Profile Gate -->
<style>
  .gate-overlay{position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:9998}
  .gate-card{background:var(--surface); border:1px solid var(--divider); border-radius:16px; padding:20px; width:min(92vw, 420px); box-shadow:0 30px 50px rgba(0,0,0,.45)}
  .gate-card h3{font-family:'Playfair Display',serif; margin:0 0 10px}
  .gate-row{display:flex; gap:10px; margin:10px 0}
  .gate-card input{flex:1; background:#0f1115; color:var(--cream); border:1px solid var(--divider); border-radius:10px; padding:10px}
  .gate-actions{display:flex; gap:10px; justify-content:flex-end; margin-top:12px}
  .btn-small{padding:10px 14px; border-radius:10px; border:1px solid var(--divider); background:transparent; color:var(--cream); cursor:pointer}
  .btn-small.primary{background:var(--gold); color:#111; border:none}
  .gate-error{color:#ff9b9b; font-weight:700; font-size:.9rem; min-height:1.2em}
</style>
<div id="profileGate" class="gate-overlay" role="dialog" aria-modal="true">
  <div class="gate-card">
    <h3>Welcome! Before we begin</h3>
    <p class="muted">Please tell us your first name and confirm you are of legal drinking age.</p>
    <div class="gate-row">
      <input id="gateName" type="text" placeholder="First name" autocomplete="given-name"/>
    </div>
    <div class="gate-row">
      <input id="gateAge" type="number" min="0" placeholder="Your age"/>
    </div>
    <div id="gateError" class="gate-error"></div>
    <div class="gate-actions">
      <button id="gateCancel" class="btn-small">Cancel</button>
      <button id="gateContinue" class="btn-small primary">Continue</button>
    </div>
  </div>
  
</div>

<script>
  const API_BASE = 'https://whatsapp-cocktail-bot.onrender.com';
  const waNumber = '19844809046';
  const ORDER_URL = `${API_BASE}/order`;
  const storage = window.localStorage;
  let clientId = storage.getItem('clientId') || '';
  const pendingOrders = new Set();
  const AGE_MIN = 21; // adjust if needed

  function getProfile(){
    try { return JSON.parse(storage.getItem('guestProfile') || ''); } catch { return null; }
  }
  function saveProfile(p){ storage.setItem('guestProfile', JSON.stringify(p)); }
  function ensureProfileGate(onDone){
    const prof = getProfile();
    if (prof && prof.name && prof.age && Number(prof.age) >= AGE_MIN) { onDone && onDone(prof); return; }
    const gate = document.getElementById('profileGate');
    const nameEl = document.getElementById('gateName');
    const ageEl = document.getElementById('gateAge');
    const errEl = document.getElementById('gateError');
    gate.style.display = 'flex';
    document.getElementById('gateCancel').onclick = () => { gate.style.display = 'none'; };
    document.getElementById('gateContinue').onclick = () => {
      const n = (nameEl.value || '').trim();
      const a = parseInt(ageEl.value || '0', 10);
      if (!n) { errEl.textContent = 'Please enter your name.'; return; }
      if (!a || a < AGE_MIN) { errEl.textContent = `You must be at least ${AGE_MIN}.`; return; }
      const profile = { name: n, age: a, ts: Date.now() };
      saveProfile(profile);
      gate.style.display = 'none';
      onDone && onDone(profile);
    };
  }

  function showToast(message) {
    const box = document.getElementById('toasts');
    if (!box) return alert(message);
    const el = document.createElement('div');
    el.className = 'toast'; el.textContent = message; box.appendChild(el);
    setTimeout(() => el.remove(), 2500);
  }


  // Listen for done events via SSE
  try {
    const es = new EventSource(`${API_BASE}/events`);
    es.addEventListener('order_done', (evt) => {
      try {
        const payload = JSON.parse(evt.data || '{}');
        const matchesId = payload && payload.id && pendingOrders.has(payload.id);
        const matchesClient = payload && payload.clientId && payload.clientId === clientId;
        if (matchesId || matchesClient) {
          if (matchesId && payload.id) pendingOrders.delete(payload.id);
          if ('Notification' in window && Notification.permission === 'granted') {
            try { new Notification('Your drink is ready! ðŸŽ‰', { body: `${payload.displayName || payload.cocktail} is ready for pickup.` }); }
            catch { showToast(`${payload.displayName || payload.cocktail} is ready!`); }
          } else { showToast(`${payload.displayName || payload.cocktail} is ready!`); }
        }
      } catch (e) { console.error('SSE parse error', e); }
    });
  } catch (e) { console.warn('SSE not available', e); }

  async function placeOrder(drinkEl, canonical, displayName) {
    const btnWA = drinkEl.querySelector('.order-btn.whatsapp-btn');
    const btnON = drinkEl.querySelector('.order-btn.order-now');
    const info = drinkEl.querySelector('.stock-info');
    const origONText = btnON ? btnON.textContent : '';
    try {
      // Ensure profile before ordering
      await new Promise(resolve => ensureProfileGate(() => resolve()));
      const prof = getProfile() || {};
      [btnWA, btnON].forEach(btn => { if (btn) btn.classList.add('disabled'); });
      if (btnON) btnON.textContent = 'â³ Placing...';
      if ('Notification' in window && Notification.permission === 'default') { try { await Notification.requestPermission(); } catch {} }
      const resp = await fetch(ORDER_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ canonical, drink: displayName, clientId, name: prof.name })});
      if (resp.ok) {
        let result = {}; try { result = await resp.json(); } catch {}
        if (result && result.id) pendingOrders.add(result.id);
        showToast('We received your order. It\'s being prepared!');
        const match = /^(\d+)/.exec(info.textContent || ''); let left = match ? parseInt(match[1], 10) : 0; if (left > 0) left -= 1; info.textContent = left > 0 ? `${left} left` : '';
        if (left === 0) {
          let b = drinkEl.querySelector('.badge'); if (!b) { b = document.createElement('div'); b.className='badge'; drinkEl.insertBefore(b, drinkEl.firstChild); }
          b.textContent = 'Out of Stock';
          [btnWA, btnON].forEach(btn => { if (!btn) return; btn.classList.add('disabled'); btn.removeAttribute('href'); btn.textContent = 'Out of Stock'; });
        } else {
          if (btnON) btnON.textContent = 'âœ… Added to Queue'; setTimeout(() => { if (btnON) btnON.textContent = origONText || 'ðŸ›’ Order Now'; }, 1500);
          [btnWA, btnON].forEach(btn => { if (btn) btn.classList.remove('disabled'); });
        }
      } else if (resp.status === 409) {
        info.textContent = ''; let b = drinkEl.querySelector('.badge'); if (!b) { b = document.createElement('div'); b.className='badge'; drinkEl.insertBefore(b, drinkEl.firstChild); } b.textContent = 'Out of Stock';
      } else {
        console.error('Order failed', await resp.text()); if (btnON) btnON.textContent = 'âŒ Try Again'; showToast('Order failed. Please try again.'); setTimeout(() => { if (btnON) btnON.textContent = origONText || 'ðŸ›’ Order Now'; }, 2000);
      }
    } catch (e) {
      console.error('Order error', e); if (btnON) btnON.textContent = 'âŒ Error'; showToast('An error occurred. Please try again.'); setTimeout(() => { if (btnON) btnON.textContent = origONText || 'ðŸ›’ Order Now'; }, 2000);
    } finally {
      const badge = drinkEl.querySelector('.badge');
      const isOut = badge && /Out of Stock/i.test(badge.textContent || '');
      if (!isOut) { [btnWA, btnON].forEach(btn => { if (btn) btn.classList.remove('disabled'); }); }
    }
  }

  (async () => {
    try {
      const res = await fetch(`${API_BASE}/menu`);
      const data = await res.json();
      const grid = document.getElementById('menuGrid');
      grid.innerHTML = '';
      data.forEach(item => {
        const card = document.createElement('article');
        card.className = 'card drink';
        card.setAttribute('data-canonical', item.canonical);

        const badge = document.createElement('div');
        badge.className = 'badge';
        if (item.stock_count <= 0) badge.textContent = 'Out of Stock';
        else if (item.stock_count <= 10) { badge.classList.add('low'); badge.textContent = 'Low Stock'; }

        const imgWrap = document.createElement('div');
        imgWrap.className = 'img-wrap';
        const img = document.createElement('img');
        img.loading = 'lazy';
        img.alt = item.display_name;
        img.src = item.image_url || `https://picsum.photos/seed/${encodeURIComponent(item.canonical)}/600/400`;
        imgWrap.appendChild(img);

        const h3 = document.createElement('h3');
        h3.textContent = item.display_name;

        const p = document.createElement('p');
        p.textContent = item.description || 'Delicious cocktail from our menu.';

        const footer = document.createElement('div');
        footer.className = 'card-footer';
        const stockInfo = document.createElement('div');
        stockInfo.className = 'stock-info';
        stockInfo.textContent = item.stock_count > 0 ? `${item.stock_count} left` : '';
        const actions = document.createElement('div');
        actions.className = 'actions';

        const btnWA = document.createElement('a');
        btnWA.className = 'btn order-btn whatsapp-btn';
        btnWA.innerHTML = `<img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="height:16px"> Order`;
        if (item.stock_count <= 0) btnWA.classList.add('disabled');
        else {
          const text = encodeURIComponent(`I'd like to order the ${item.display_name}!`);
          btnWA.href = `https://wa.me/${waNumber}?text=${text}`;
        }

        const btnON = document.createElement('a');
        btnON.className = 'btn order-btn order-now';
        btnON.textContent = 'ðŸ›’ Order Now';
        if (item.stock_count <= 0) btnON.classList.add('disabled');
        else btnON.addEventListener('click', e => { e.preventDefault(); placeOrder(card, item.canonical, item.display_name); });

        actions.appendChild(btnWA);
        actions.appendChild(btnON);
        footer.appendChild(stockInfo);
        footer.appendChild(actions);

        card.appendChild(imgWrap);
        card.appendChild(h3);
        card.appendChild(p);
        if (item.stock_count <= 0 || item.stock_count <= 10) card.appendChild(badge);
        card.appendChild(footer);

        grid.appendChild(card);
      });
    } catch (err) { console.error('Stock script error', err); }
  })();
</script>

<!-- OneSignal Web Push (v16) -->
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  (async () => {
    try {
      const cfg = await fetch('https://whatsapp-cocktail-bot.onrender.com/onesignal/config')
        .then(r => r.json())
        .catch(() => ({ appId: null }));
      if (!cfg || !cfg.appId) return; // OneSignal not configured
      window.OneSignalDeferred = window.OneSignalDeferred || [];
      window.OneSignalDeferred.push(async function(OneSignal) {
        await OneSignal.init({ appId: cfg.appId, serviceWorkerPath: '/sw.js' });
        console.log("âœ… OneSignal SDK initialized");
        try {
          const cid = localStorage.getItem('clientId') || '';
          if (cid) { await OneSignal.login(String(cid)); }
        } catch (e) { console.warn('OneSignal login failed', e); }
        // Debug logs on every load (with retries)
        const logStatus = async () => {
          try {
            const clientIdLog = localStorage.getItem('clientId');
            console.log("ðŸ†” ClientId (localStorage):", clientIdLog);
            const pushId = await OneSignal.User.PushSubscription.id;
            console.log("ðŸ”” OneSignal PushSubscription.id:", pushId);
          } catch (err) {
            console.warn("PushSubscription log failed", err);
          }
        };
        logStatus();
        setTimeout(logStatus, 3000);
        setTimeout(logStatus, 7000);
        try { OneSignal.Slidedown.promptPush(); } catch {}
      });
    } catch (e) { console.warn('OneSignal init error', e); }
  })();
</script>
</body>
</html>
