<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üéâ Birthday Drinks Menu üéâ</title>
  <link rel="stylesheet" href="./merchant-theme.css" />
  <style>
    :root {
      --accent:   #7b5cff;
      --accent-2: #ff6aa8;
      --card:     #ffffff;
      --muted:    #6b7280;
    }

    html, body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #111827;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      background:
        radial-gradient(1000px 800px at 10% 10%, #ffd6f0 0%, transparent 50%),
        radial-gradient(900px 700px at 90% 20%, #ffe2b8 0%, transparent 55%),
        radial-gradient(900px 900px at 50% 100%, #c8f4ff 0%, transparent 55%),
        linear-gradient(135deg, #fff3fb, #eefaff);
    }

    header {
      text-align: center;
      padding: 20px;
      position: relative;
      z-index: 1;
    }

    h1 {
      font-size: 2.5rem;
      color: var(--accent);
      text-shadow: 1px 1px 4px rgba(0,0,0,0.15);
      margin: 0;
    }

    h2 {
      font-size: 1.2rem;
      color: var(--accent-2);
      margin: 0;
    }

    .menu {
      width: 100%;
      max-width: 900px;
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      padding: 20px;
      box-sizing: border-box;
      position: relative;
      z-index: 1;
    }

    .drink {
      position: relative;
      background: var(--card);
      border-radius: 20px;
      padding: 18px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.10);
      border: 2px dashed #e5e7eb;
      color: #2d2d2d;
      width: calc(50% - 10px);
      box-sizing: border-box;
      opacity: 0;
      transform: translateY(20px);
      animation: fadeInUp 0.6s ease forwards;
      transition: transform .15s ease, box-shadow .15s ease;
    }

    .drink:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 34px rgba(0,0,0,0.14);
    }

    .drink:nth-child(1) { animation-delay: 0s; }
    .drink:nth-child(2) { animation-delay: 0.1s; }
    .drink:nth-child(3) { animation-delay: 0.2s; }
    .drink:nth-child(4) { animation-delay: 0.3s; }
    .drink:nth-child(5) { animation-delay: 0.4s; }
    .drink:nth-child(6) { animation-delay: 0.5s; }

    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }

    .drink h3 {
      margin: 0 0 10px;
      color: var(--accent-2);
      font-size: 1.2rem;
    }

    .drink p {
      margin: 0 0 12px;
      font-size: 1rem;
      line-height: 1.4;
      color:#374151;
    }

    .drink .badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(255,255,255,0.9);
      color: #d00;
      font-weight: bold;
      padding: 4px 8px;
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .order-btn {
      background: var(--accent);
      color: white;
      padding: 10px 14px;
      border-radius: 12px;
      text-decoration: none;
      font-weight: 800;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 24px rgba(123,92,255,0.35);
      transition: transform .15s ease, box-shadow .15s ease, background-color .2s ease;
    }

    .order-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 30px rgba(123,92,255,0.45);
    }

    .order-btn img {
      height: 16px;
    }

    /* Put a little space between adjacent order buttons */
    .order-btn + .order-btn {
      margin-left: 8px;
    }

    .order-btn.disabled {
      background-color: #ccc;
      cursor: not-allowed;
      pointer-events: none;
      box-shadow: none;
    }

    .stock-info { display: none; }

    /* Toast notifications */
    .toast-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
    }
    .toast {
      background: #111827;
      color: #fff;
      padding: 10px 14px;
      border-radius: 10px;
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
      font-weight: 600;
      opacity: 0.95;
      max-width: 90vw;
    }

    @media (max-width: 600px) {
      .drink { width: 100%; }
    }

    #confetti {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
    }

    .balloon {
      position: fixed;
      width: 80px;
      height: 100px;
      border-radius: 50% 50% 45% 55%;
      background: radial-gradient(circle at 30% 30%, #fff8, transparent 40%), #ff6aa8;
      box-shadow: inset -10px -16px 24px rgba(0,0,0,0.15);
      animation: float 12s ease-in-out infinite;
      opacity: .75;
      z-index: 0;
    }

    .balloon::after {
      content: "";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: -26px;
      width: 2px;
      height: 60px;
      background: #2223;
    }

    .b1 { left: 6%;  bottom: -10%; animation-delay: -1s; background:#ff6aa8; }
    .b2 { left: 78%; bottom: -20%; animation-delay: -3s; background:#7b5cff; }
    .b3 { left: 46%; bottom: -15%; animation-delay: -5s; background:#ffd166; }

    @keyframes float {
      0%   { transform: translateY(0) }
      50%  { transform: translateY(-30vh) }
      100% { transform: translateY(0) }
    }
  </style>
</head>
<body>
  <canvas id="confetti"></canvas>

  <header>
    <h1>üéâ HAPPY BIRTHDAY KRISTIN!!!! üéâ</h1>
    <h2>Birthday Drinks Menu üçπ</h2>
  </header>

  <section class="menu-grid">

    <!-- Kristin Bday Margarita -->
    <div class="card drink" data-canonical="Tommys Margarita">
      <div class="img-wrap">
        <img loading="lazy" src="https://ellegourmet.ca/wp-content/uploads/2023/04/2023-0223-EG-3856-scaled-e1681778702757.jpg" alt="Margarita" onerror="this.onerror=null;this.src='https://picsum.photos/seed/margarita/1200/900';"/>
      </div>
      <h3>Kristin Bday Margarita üå∫</h3>
      <p>A lighter take on the classic ‚Äî tequila, fresh lime juice, and agave syrup for a naturally sweet and citrusy refreshment.</p>
      <p class="stock-info"></p>
      <a class="order-btn whatsapp-btn" href="https://wa.me/19844809046?text=I%27d%20like%20to%20order%20the%20Kristin%20Bday%20Margarita%20!">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">Order WhatsApp
      </a>
      <a class="order-btn order-now" href="#">üõí Order Now</a>
    </div>

    <!-- Kristin Mojito -->
    <div class="card drink" data-canonical="Regular Mojito">
      <div class="img-wrap">
        <img loading="lazy" src="https://cdn.prod.website-files.com/594bcc8db100b47a2a8c2e38/63c56ab1e9a2118a419d7478_5c3dd63342cd1574af5ac0e4_Mojito-p-1080.webp" alt="Mojito" onerror="this.onerror=null;this.src='https://picsum.photos/seed/mojito/1200/900';"/>
      </div>
      <div class="badge">Out of Stock</div>
      <h3>Kristin Mojito üåø</h3>
      <p>Crisp mint leaves muddled with lime and sugar, topped with white rum and soda water for ultimate freshness.</p>
      <p class="stock-info"></p>
      <a class="order-btn whatsapp-btn disabled"></a>
      <a class="order-btn order-now disabled"></a>
    </div>

    <!-- Kristin Gin Southside -->
    <div class="card drink" data-canonical="Gin Southside">
      <div class="img-wrap">
        <img loading="lazy" src="https://images.squarespace-cdn.com/content/v1/5668afe4c21b86d8ce6fc49c/1550351337684-7X5ZX29ZLZ64WDL0OYIN/EditorialCocktails_2x_0046_Southside_Gallery3X.png.png?format=1500w" alt="Gin Southside" onerror="this.onerror=null;this.src='https://picsum.photos/seed/southside/1200/900';"/>
      </div>
      <div class="badge">Out of Stock</div>
      <h3>Kristin Gin Southside üç∏</h3>
      <p>A refreshing blend of gin, mint, lime, and simple syrup ‚Äî Kristin‚Äôs twist on the Southside classic.</p>
      <p class="stock-info"></p>
      <a class="order-btn whatsapp-btn disabled"></a>
      <a class="order-btn order-now disabled"></a>
    </div>

    <!-- Paloma Paradise -->
    <div class="card drink" data-canonical="Paloma">
      <div class="img-wrap">
        <img loading="lazy" src="https://images.pexels.com/photos/16444380/pexels-photo-16444380.jpeg?cs=srgb&dl=pexels-esmihel-16444380.jpg&fm=jpg" alt="Paloma" onerror="this.onerror=null;this.src='https://picsum.photos/seed/paloma/1200/900';"/>
      </div>
      <div class="badge">Out of Stock</div>
      <h3>Paloma Paradise üçä</h3>
      <p>Tequila, grapefruit soda, and lime juice create this zesty, bubbly Mexican classic with a touch of sea salt.</p>
      <p class="stock-info"></p>
      <a class="order-btn whatsapp-btn disabled"></a>
      <a class="order-btn order-now disabled"></a>
    </div>

    <!-- Cosmo Crush -->
    <div class="card drink" data-canonical="Cosmopolitan">
      <div class="img-wrap">
        <img loading="lazy" src="https://www.foodandwine.com/thmb/acb9flfE2zc1INtjCpMv8slaVvs=/750x0/filters:no_upscale():max_bytes(150000):strip_icc()/Cosmopolitan-FT-BLOG1122-34b1c314ea3b4b338535f4dd93b754a7.jpg" alt="Cosmopolitan" onerror="this.onerror=null;this.src='https://picsum.photos/seed/cosmo/1200/900';"/>
      </div>
      <div class="badge">Out of Stock</div>
      <h3>Cosmo Crush üíã</h3>
      <p>Elegant and tart ‚Äî vodka, cranberry juice, orange liqueur, and fresh lime served in a chilled martini glass.</p>
      <p class="stock-info"></p>
      <a class="order-btn whatsapp-btn disabled"></a>
      <a class="order-btn order-now disabled"></a>
    </div>

    <!-- Espresso Kristinni -->
    <div class="card drink" data-canonical="Espresso Martini">
      <div class="img-wrap">
        <img loading="lazy" src="https://filodeagave.com/wp-content/uploads/2024/08/Tequila-Espresso-Martini-Cocktail-Recipe-v002.jpg" alt="Espresso Martini" onerror="this.onerror=null;this.src='https://picsum.photos/seed/espresso/1200/900';"/>
      </div>
      <h3>Espresso Kristinni ‚òï</h3>
      <p>A creamy caffeine kick ‚Äî vodka, espresso, and coffee liqueur shaken over ice and garnished with espresso beans.</p>
      <p class="stock-info"></p>
      <a class="order-btn whatsapp-btn" href="https://wa.me/19844809046?text=I%27d%20like%20to%20order%20the%20Espresso%20Kristinni%20!">
        <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp">Order WhatsApp
      </a>
      <a class="order-btn order-now" href="#">üõí Order Now</a>
    </div>

  </section>

  <div id="toasts" class="toast-container" aria-live="polite" aria-atomic="true"></div>

  <div class="balloon b1"></div>
  <div class="balloon b2"></div>
  <div class="balloon b3"></div>

<script>
  (function(){
    const c = document.getElementById('confetti');
    const ctx = c.getContext('2d');
    let W, H, pieces;

    function reset() {
      W = c.width = window.innerWidth;
      H = c.height = window.innerHeight;
      pieces = Array.from({length: 150}, () => ({
        x: Math.random() * W,
        y: Math.random() * -H,
        r: 4 + Math.random() * 6,
        a: Math.random() * Math.PI * 2,
        v: 1 + Math.random() * 3,
        s: 0.01 + Math.random() * 0.02
      }));
    }

    function draw() {
      ctx.clearRect(0, 0, W, H);
      for (const p of pieces) {
        p.y += p.v;
        p.a += p.s;
        if (p.y > H + 20) {
          p.x = Math.random() * W;
          p.y = -20;
        }
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.a);
        ctx.fillStyle = ['#7b5cff','#ff6aa8','#ffd166','#00d3ff','#00d39b'][p.y % 5 | 0];
        ctx.fillRect(-p.r/2, -p.r/2, p.r, p.r*1.6);
        ctx.restore();
      }
      requestAnimationFrame(draw);
    }

    window.addEventListener('resize', reset);
    reset();
    draw();
  })();

  (async () => {
    try {
      const API_BASE = 'https://whatsapp-cocktail-bot.onrender.com';
      const res = await fetch(`${API_BASE}/menu`);
      const data = await res.json();
      const menuMap = {};
      data.forEach(item => { menuMap[item.canonical] = item.stock_count; });

      // Contact configuration
      const waNumber = '19844809046';
      const ORDER_URL = `${API_BASE}/order`;
      // Track pending orders by id so we can notify on completion
      const pendingOrders = new Set();
      const storage = window.localStorage;
      let clientId = storage.getItem('clientId') || '';
      const AGE_MIN = 21;

      function getProfile(){ try { return JSON.parse(storage.getItem('guestProfile') || ''); } catch { return null; } }
      function saveProfile(p){ storage.setItem('guestProfile', JSON.stringify(p)); }
      function ensureProfileGate(onDone){
        let gate = document.getElementById('profileGate');
        if (!gate) {
          gate = document.createElement('div'); gate.id = 'profileGate'; gate.className = 'gate-overlay';
          gate.innerHTML = `<div class="gate-card"><h3>Welcome! Before we begin</h3><p class="muted">Please tell us your first name and confirm you are of legal drinking age.</p><div class="gate-row"><input id="gateName" type="text" placeholder="First name" autocomplete="given-name"/></div><div class="gate-row"><input id="gateAge" type="number" min="0" placeholder="Your age"/></div><div id="gateError" class="gate-error"></div><div class="gate-actions"><button id="gateCancel" class="btn-small">Cancel</button><button id="gateContinue" class="btn-small primary">Continue</button></div></div>`;
          document.body.appendChild(gate);
        }
        const prof = getProfile();
        if (prof && prof.name && prof.age && Number(prof.age) >= AGE_MIN) { onDone && onDone(prof); return; }
        const nameEl = document.getElementById('gateName');
        const ageEl = document.getElementById('gateAge');
        const errEl = document.getElementById('gateError');
        gate.style.display = 'flex';
        document.getElementById('gateCancel').onclick = () => { gate.style.display = 'none'; };
        document.getElementById('gateContinue').onclick = () => {
          const n = (nameEl.value || '').trim(); const a = parseInt(ageEl.value || '0', 10);
          if (!n) { errEl.textContent = 'Please enter your name.'; return; }
          if (!a || a < AGE_MIN) { errEl.textContent = `You must be at least ${AGE_MIN}.`; return; }
          const profile = { name: n, age: a, ts: Date.now() };
          saveProfile(profile); gate.style.display = 'none'; onDone && onDone(profile);
        };
      }
      // Connect to SSE for order events
      try {
        const es = new EventSource(`${API_BASE}/events`);
        es.addEventListener('order_done', (evt) => {
          try {
            const payload = JSON.parse(evt.data || '{}');
            const matchesId = payload && payload.id && pendingOrders.has(payload.id);
            const matchesClient = payload && payload.clientId && payload.clientId === clientId;
            if (matchesId || matchesClient) {
              if (matchesId && payload.id) pendingOrders.delete(payload.id);
              if ('Notification' in window && Notification.permission === 'granted') {
                try { new Notification('Your drink is ready! üéâ', { body: `${payload.displayName || payload.cocktail} is ready for pickup.` }); }
                catch { showToast(`${payload.displayName || payload.cocktail} is ready!`); }
              } else {
                showToast(`${payload.displayName || payload.cocktail} is ready!`);
              }
            }
          } catch (e) { console.error('SSE parse error', e); }
        });
      } catch (e) {
        console.warn('SSE not available', e);
      }

      async function placeOrder(drinkEl, canonical, displayName) {
        const btnWA = drinkEl.querySelector('.order-btn.whatsapp-btn');
        const btnON = drinkEl.querySelector('.order-btn.order-now');
        const info = drinkEl.querySelector('.stock-info');
        const origONText = btnON ? btnON.textContent : '';
        try {
          [btnWA, btnON].forEach(btn => { if (btn) { btn.classList.add('disabled'); } });
          if (btnON) btnON.textContent = '‚è≥ Placing...';
          // Ensure browser permission and push subscription
          if ('Notification' in window && Notification.permission === 'default') {
            try { await Notification.requestPermission(); } catch {}
          }
          await ensurePushSubscription();
          const resp = await fetch(ORDER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ canonical, drink: displayName, clientId })
          });
          if (resp.ok) {
            // Parse id and ask for notification permission
            let result = {};
            try { result = await resp.json(); } catch {}
            if (result && result.id) {
              pendingOrders.add(result.id);
            }
            // Immediate confirmation toast
            showToast('We received your order. It\'s being prepared!');
            // Decrement locally
            const match = /^(\d+)/.exec(info.textContent || '');
            let left = match ? parseInt(match[1], 10) : 0;
            if (left > 0) left -= 1;
            info.textContent = left > 0 ? `${left} left` : 'Out of stock';
            // Update UI if sold out now
            if (left === 0) {
              let badgeEl = drinkEl.querySelector('.badge');
              if (!badgeEl) { badgeEl = document.createElement('div'); badgeEl.className = 'badge'; drinkEl.insertBefore(badgeEl, drinkEl.firstChild); }
              badgeEl.textContent = 'Out of Stock';
              [btnWA, btnON].forEach(btn => {
                if (!btn) return;
                btn.classList.add('disabled');
                btn.removeAttribute('href');
                btn.innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/No_entry_sign.svg/1024px-No_entry_sign.svg.png" alt="Out of Stock" style="height:16px;vertical-align:middle;margin-right:6px;">';
              });
            } else {
              if (btnON) btnON.textContent = '‚úÖ Added to Queue';
              setTimeout(() => { if (btnON) btnON.textContent = origONText || 'üõí Order Now'; }, 1500);
              [btnWA, btnON].forEach(btn => { if (btn) { btn.classList.remove('disabled'); } });
            }
          } else if (resp.status === 409) {
            // Out of stock per server
            info.textContent = 'Out of stock';
            let badgeEl = drinkEl.querySelector('.badge');
            if (!badgeEl) { badgeEl = document.createElement('div'); badgeEl.className = 'badge'; drinkEl.insertBefore(badgeEl, drinkEl.firstChild); }
            badgeEl.textContent = 'Out of Stock';
          } else {
            console.error('Order failed', await resp.text());
            if (btnON) btnON.textContent = '‚ùå Try Again'; showToast('Order failed. Please try again.');
            setTimeout(() => { if (btnON) btnON.textContent = origONText || 'üõí Order Now'; }, 2000);
          }
        } catch (e) {
          console.error('Order error', e);
          if (btnON) btnON.textContent = '‚ùå Error'; showToast('An error occurred. Please try again.');
          setTimeout(() => { if (btnON) btnON.textContent = origONText || 'üõí Order Now'; }, 2000);
        } finally {
          // If still in stock, re-enable buttons
          if (!/Out of stock/i.test(info.textContent)) {
            [btnWA, btnON].forEach(btn => { if (btn) { btn.classList.remove('disabled'); } });
          }
        }
      }

      document.querySelectorAll('.drink').forEach(drinkEl => {
        const canonical = drinkEl.getAttribute('data-canonical');
        const stock = menuMap[canonical] || 0;
        const info = drinkEl.querySelector('.stock-info');
        info.textContent = stock > 0 ? `${stock} left` : 'Out of stock';

        let badgeEl = drinkEl.querySelector('.badge');
        const btnWA = drinkEl.querySelector('.order-btn.whatsapp-btn');
        const btnON = drinkEl.querySelector('.order-btn.order-now');
        const displayName = drinkEl.querySelector('h3').innerText.trim();
        const text = encodeURIComponent(`I'd like to order the ${displayName}!`);

        if (stock === 0) {
          if (!badgeEl) {
            badgeEl = document.createElement('div');
            badgeEl.className = 'badge';
            drinkEl.insertBefore(badgeEl, drinkEl.firstChild);
          }
          badgeEl.textContent = 'Out of Stock';
          // Disable both buttons
          [btnWA, btnON].forEach(btn => {
            if (!btn) return;
            btn.classList.add('disabled');
            btn.removeAttribute('href');
            btn.innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/e0/No_entry_sign.svg/1024px-No_entry_sign.svg.png" alt="Out of Stock" style="height:16px;vertical-align:middle;margin-right:6px;">';
          });
        } else if (stock <= 10) {
          if (!badgeEl) {
            badgeEl = document.createElement('div');
            badgeEl.className = 'badge';
            drinkEl.insertBefore(badgeEl, drinkEl.firstChild);
          }
          badgeEl.textContent = 'Low Stock';
          if (btnWA) {
            btnWA.classList.remove('disabled');
            btnWA.innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="height:16px;vertical-align:middle;margin-right:6px;">Order WhatsApp';
            btnWA.setAttribute('href', `https://wa.me/${waNumber}?text=${text}`);
          }
          if (btnON) {
            btnON.classList.remove('disabled');
            btnON.textContent = 'üõí Order Now';
            btnON.addEventListener('click', (e) => { e.preventDefault(); placeOrder(drinkEl, canonical, displayName); });
          }
        } else {
          if (badgeEl) badgeEl.remove();
          if (btnWA) {
            btnWA.classList.remove('disabled');
            btnWA.innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="WhatsApp" style="height:16px;vertical-align:middle;margin-right:6px;">Order WhatsApp';
            btnWA.setAttribute('href', `https://wa.me/${waNumber}?text=${text}`);
          }
          if (btnON) {
            btnON.classList.remove('disabled');
            btnON.textContent = 'üõí Order Now';
            btnON.addEventListener('click', (e) => { e.preventDefault(); placeOrder(drinkEl, canonical, displayName); });
          }
        }
      });
    } catch (err) {
      console.error('Stock script error', err);
    }
  })();
</script>
</body>
</html>